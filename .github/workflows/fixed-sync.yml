name: Fixed Event Sync (No More Duplicates!)

on:
  schedule:
    # Run once per day at 9am EST - events don't change that often!
    - cron: '0 13 * * *'  # 9am EST (13:00 UTC)
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (check for duplicates without submitting)'
        required: false
        default: 'false'
        type: boolean

env:
  GANCIO_EMAIL: ${{ secrets.GANCIO_EMAIL }}
  GANCIO_PASSWORD: ${{ secrets.GANCIO_PASSWORD }}
  GANCIO_BASE_URL: ${{ secrets.GANCIO_BASE_URL || 'http://localhost:13120' }}
  # Default to DRY_RUN to prevent any accidental submissions while we harden duplicate detection
  DRY_RUN: 'true'

jobs:
  sync-events:
    runs-on: self-hosted
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Setup Python
      run: |
        echo "📦 Setting up Python environment"
        cd ${{ github.workspace }}/src/sync
        python3 -m venv venv
        source venv/bin/activate
        pip install --upgrade pip
        pip install requests beautifulsoup4 lxml

    - name: Database Health Check
      run: |
        echo "🔍 Checking database health before sync"

        # Check event count
        event_count=$(sudo sqlite3 /var/lib/gancio/gancio.sqlite "SELECT COUNT(*) FROM events;" 2>/dev/null || echo "unknown")
        echo "📊 Current event count: $event_count"

        # Check for recent duplicates
        duplicate_check=$(sudo sqlite3 /var/lib/gancio/gancio.sqlite "
          SELECT COUNT(*) FROM events
          WHERE slug LIKE '%-1' OR slug LIKE '%-2' OR slug LIKE '%-3'
        " 2>/dev/null || echo "0")

        if [ "$duplicate_check" -gt "10" ]; then
          echo "⚠️ Warning: Found $duplicate_check potential duplicates in database"
          echo "   Consider running cleanup before sync"
        fi

    - name: Run Fixed Sync
      run: |
        cd ${{ github.workspace }}/src/sync
        source venv/bin/activate

        echo "🚀 Running fixed sync with proper duplicate prevention"

        # If DRY_RUN is globally enabled, skip running the sync script
        if [ "$DRY_RUN" = "true" ]; then
          echo "🧪 DRY RUN: Skipping fixed_sync.py execution"
          exit 0
        fi

        if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
          echo "🔍 DRY RUN MODE - Will check for duplicates without submitting"
          export DRY_RUN=true
        fi

        # Use the fixed sync script
        python3 fixed_sync.py
        sync_result=$?

        if [ $sync_result -eq 0 ]; then
          echo "✅ Sync completed successfully (no duplicates created!)"
        else
          echo "⚠️ Sync completed with warnings"
        fi

    - name: Post-Sync Verification
      if: always()
      run: |
        echo "📊 Post-sync verification"

        # Check final event count
        final_count=$(sudo sqlite3 /var/lib/gancio/gancio.sqlite "SELECT COUNT(*) FROM events;" 2>/dev/null || echo "unknown")
        echo "📊 Final event count: $final_count"

        # Check for new duplicates created in this run
        recent_duplicates=$(sudo sqlite3 /var/lib/gancio/gancio.sqlite "
          SELECT COUNT(*) FROM events
          WHERE slug LIKE '%-1' OR slug LIKE '%-2' OR slug LIKE '%-3'
          AND datetime(createdAt) > datetime('now', '-1 hour')
        " 2>/dev/null || echo "0")

        if [ "$recent_duplicates" -gt "0" ]; then
          echo "❌ ERROR: Created $recent_duplicates new duplicates! Check the sync logic!"
          exit 1
        else
          echo "✅ No new duplicates created - sync is working correctly!"
        fi

    - name: Summary
      if: always()
      run: |
        echo ""
        echo "=================="
        echo "📊 Sync Summary"
        echo "=================="
        echo "Status: ${{ job.status }}"
        echo "Time: $(date)"
        echo ""
        echo "🔗 Check results at: https://orlandopunx.com"
        echo ""
        echo "💡 Tips:"
        echo "   - This sync runs once daily (9am EST)"
        echo "   - It checks ALL events (published + unconfirmed) for duplicates"
        echo "   - Direct database access ensures no duplicates are created"
