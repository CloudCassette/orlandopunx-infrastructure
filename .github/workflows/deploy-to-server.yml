name: 🎸 Deploy Orlando Punk Shows Infrastructure

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allow manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: 🚀 Deploy to Production Server
    
    steps:
    - name: 🔄 Checkout Repository
      uses: actions/checkout@v4
      
    - name: 📡 Deploy via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "🎸 Starting OrlandoPunx.com deployment..."
          
          # Navigate to infrastructure repo
          cd /home/cloudcassette/orlandopunx-infrastructure || exit 1
          
          # Pull latest changes
          echo "📥 Pulling latest changes..."
          git pull origin main || exit 1
          
          # Simple success confirmation
          echo "✅ Code deployment completed successfully!"
          echo "📝 Current commit: $(git rev-parse --short HEAD)"
          echo "📅 Deployed at: $(date)"
          
          # Log deployment to user directory
          mkdir -p /home/cloudcassette/logs
          echo "$(date): Successfully deployed commit $(git rev-parse --short HEAD)" >> /home/cloudcassette/logs/orlandopunx-deployment.log || true

  notify:
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    name: 📢 Notify Deployment Status
    
    steps:
    - name: 📧 Send Discord Notification
      if: always()
      uses: tsickert/discord-webhook@v6.0.0
      with:
        webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
        content: |
          🎸 **OrlandoPunx.com Deployment**
          
          **Status:** ${{ needs.deploy.result == 'success' && '✅ Success' || '❌ Failed' }}
          **Repository:** ${{ github.repository }}
          **Commit:** `${{ github.sha }}`
          **Author:** ${{ github.actor }}
          **Message:** ${{ github.event.head_commit.message }}
          
          **Action Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
