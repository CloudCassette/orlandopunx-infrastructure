name: ğŸ” Validate Orlando Punk Shows Changes

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    name: ğŸ§ª Test and Validate Changes
    
    steps:
    - name: ğŸ”„ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ” Validate SEO Files
      run: |
        echo "ğŸ” Validating SEO files..."
        
        # Check if sitemap.xml exists and has basic structure
        if [ -f "seo/sitemap.xml" ]; then
          echo "âœ… Sitemap file exists"
          if grep -q "<?xml" seo/sitemap.xml && grep -q "urlset" seo/sitemap.xml; then
            echo "âœ… Sitemap has basic XML structure"
          else
            echo "âŒ Sitemap XML structure appears invalid"
            exit 1
          fi
        fi
        
        # Check robots.txt format
        if [ -f "seo/robots.txt" ]; then
          echo "âœ… Robots.txt file exists"
          if grep -q "Sitemap:" seo/robots.txt; then
            echo "âœ… Robots.txt contains sitemap reference"
          else
            echo "âš ï¸  Robots.txt missing sitemap reference"
          fi
        fi
        
        echo "âœ… SEO validation completed"

    - name: ğŸ¨ Validate Assets
      run: |
        echo "ğŸ¨ Validating assets..."
        
        # Check favicon exists
        if [ -f "icons8-poster-64.png" ]; then
          echo "âœ… Favicon found"
          # Check file size (should be reasonable for a 64x64 PNG)
          size=$(stat -c%s "icons8-poster-64.png")
          if [ $size -gt 100 ] && [ $size -lt 10000 ]; then
            echo "âœ… Favicon size looks reasonable ($size bytes)"
          else
            echo "âš ï¸  Favicon size seems unusual ($size bytes)"
          fi
        fi
        
        # List CSS files
        echo "CSS files found:"
        find . -name "*.css" -type f | head -10

    - name: ğŸ› ï¸ Validate Scripts
      run: |
        echo "ğŸ› ï¸ Validating scripts..."
        
        # Check shell scripts exist and are executable
        script_count=0
        for script in $(find . -name "*.sh" -type f); do
          echo "Checking script: $script"
          if [ -x "$script" ] || chmod +x "$script"; then
            echo "  âœ… Script is/made executable"
            # Basic syntax check
            if bash -n "$script"; then
              echo "  âœ… Script syntax is valid"
            else
              echo "  âŒ Script syntax error in $script"
              exit 1
            fi
          else
            echo "  âŒ Cannot make script executable: $script"
            exit 1
          fi
          script_count=$((script_count + 1))
        done
        
        echo "âœ… Validated $script_count shell scripts"

    - name: ğŸ“š Validate Documentation
      run: |
        echo "ğŸ“š Validating documentation..."
        
        # Check that key documentation files exist
        required_docs=("README.md" "CONTRIBUTING.md")
        
        for doc in "${required_docs[@]}"; do
          if [ -f "$doc" ]; then
            echo "âœ… $doc exists"
            # Check file is not empty
            if [ -s "$doc" ]; then
              echo "  âœ… $doc is not empty"
            else
              echo "  âŒ $doc is empty"
              exit 1
            fi
          else
            echo "âŒ Missing required documentation: $doc"
            exit 1
          fi
        done
        
        # Check docs directory
        if [ -d "docs" ]; then
          doc_count=$(find docs -name "*.md" | wc -l)
          echo "âœ… Found $doc_count documentation files in docs/"
        fi

    - name: ğŸ” Basic Security Check
      run: |
        echo "ğŸ” Running basic security checks..."
        
        # Check for obvious secrets in non-template files
        if find . -name "*.json" -not -name "*.template" -not -path "./.git/*" -exec grep -l "password" {} \; | grep -v node_modules; then
          echo "âš ï¸  Found 'password' in JSON files - please review"
        else
          echo "âœ… No obvious password leaks in JSON files"
        fi
        
        # Check that template files exist for sensitive configs
        if [ -f "configs/gancio/config.json.template" ]; then
          echo "âœ… Gancio config template exists"
        fi
        
        echo "âœ… Basic security check completed"

    - name: ğŸ“‹ Summary
      run: |
        echo "ğŸ¸ Orlando Punk Shows - Validation Summary"
        echo "========================================"
        echo "âœ… All validation checks passed!"
        echo "ğŸš€ Changes are ready for deployment"
        echo ""
        echo "Repository structure:"
        echo "ğŸ“ $(find . -name "*.md" | wc -l) documentation files"
        echo "ğŸ”§ $(find . -name "*.sh" | wc -l) shell scripts" 
        echo "âš™ï¸  $(find . -name "*.yml" -o -name "*.yaml" | wc -l) configuration files"
        echo "ğŸ¨ $(find . -name "*.css" | wc -l) style files"
        echo "ğŸ–¼ï¸  $(find . -name "*.png" -o -name "*.jpg" -o -name "*.gif" | wc -l) image files"
        echo ""
        echo "ğŸ¸ Ready to rock the Orlando punk scene! ğŸ¤˜"
