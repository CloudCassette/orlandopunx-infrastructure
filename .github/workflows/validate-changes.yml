name: ğŸ” Validate Orlando Punk Shows Changes

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    name: ğŸ§ª Test and Validate Changes
    
    steps:
    - name: ğŸ”„ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ” Validate SEO Files
      run: |
        echo "ğŸ” Validating SEO files..."
        
        # Check if sitemap.xml is valid XML
        if [ -f "seo/sitemap.xml" ]; then
          echo "Validating sitemap.xml..."
          xmllint --noout seo/sitemap.xml && echo "âœ… Sitemap is valid XML" || echo "âŒ Sitemap XML validation failed"
        fi
        
        # Check robots.txt format
        if [ -f "seo/robots.txt" ]; then
          echo "Validating robots.txt..."
          if grep -q "Sitemap:" seo/robots.txt; then
            echo "âœ… Robots.txt contains sitemap reference"
          else
            echo "âš ï¸  Robots.txt missing sitemap reference"
          fi
        fi
        
        # Validate scripts are executable
        find seo/ -name "*.sh" -exec chmod +x {} \;
        echo "âœ… SEO scripts made executable"

    - name: ğŸ¨ Validate Assets
      run: |
        echo "ğŸ¨ Validating assets..."
        
        # Check favicon exists and is correct format
        if [ -f "icons8-poster-64.png" ]; then
          file icons8-poster-64.png
          echo "âœ… Favicon found and validated"
        fi
        
        # Check CSS files
        find . -name "*.css" -exec echo "CSS file: {}" \;

    - name: ğŸ› ï¸ Validate Scripts
      run: |
        echo "ğŸ› ï¸ Validating scripts..."
        
        # Make all shell scripts executable
        find . -name "*.sh" -exec chmod +x {} \;
        
        # Basic syntax check for bash scripts
        find . -name "*.sh" -exec bash -n {} \; && echo "âœ… All shell scripts have valid syntax" || echo "âŒ Shell script syntax errors found"

    - name: ğŸ“š Validate Documentation
      run: |
        echo "ğŸ“š Validating documentation..."
        
        # Check that key documentation files exist
        required_docs=("README.md" "CONTRIBUTING.md" "docs/API_DOCUMENTATION.md" "docs/DEPLOYMENT_GUIDE.md")
        
        for doc in "${required_docs[@]}"; do
          if [ -f "$doc" ]; then
            echo "âœ… $doc exists"
          else
            echo "âŒ Missing required documentation: $doc"
          fi
        done

    - name: ğŸ” Security Check
      run: |
        echo "ğŸ” Running security checks..."
        
        # Check for accidentally committed secrets
        if grep -r "password.*=" --include="*.json" --include="*.js" --include="*.md" . | grep -v template | grep -v example; then
          echo "âš ï¸  Potential secrets found in files - review needed"
        else
          echo "âœ… No obvious secrets found in committed files"
        fi
        
        # Check file permissions
        find . -name "*.sh" -not -perm -u+x -exec echo "âš ï¸  Script not executable: {}" \;

  lint:
    runs-on: ubuntu-latest
    name: ğŸ§¹ Lint and Format Check
    
    steps:
    - name: ğŸ”„ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ§¹ Markdown Lint
      uses: articulate/actions-markdownlint@v1
      with:
        config: |
          {
            "line-length": false,
            "no-duplicate-header": false
          }
        files: '**/*.md'
        ignore: 'node_modules'
        
    - name: ğŸ“ Check Links in Documentation
      run: |
        echo "ğŸ“ Checking for broken links in documentation..."
        
        # Simple check for common link patterns
        grep -r "http" --include="*.md" . | grep -E "(http://|https://)" | while read -r line; do
          echo "Found link: $line"
        done
        
        echo "âœ… Link check completed"
