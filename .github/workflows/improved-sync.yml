name: ðŸŽ¸ Orlando Events Sync (Enhanced Debug)

on:
  schedule:
    - cron: '0 9,15,21 * * *'  # Run 3 times daily: 9am, 3pm, 9pm EST
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug output'
        required: false
        default: 'false'
        type: boolean

jobs:
  sync-events:
    runs-on: self-hosted
    name: ðŸŽµ Sync Events from Orlando Venues (Enhanced)
    
    steps:
    - name: ðŸ”„ Checkout Repository
      uses: actions/checkout@v4

    - name: ðŸ” Pre-Flight Environment Check
      run: |
        echo "ðŸ–¥ï¸  Environment Pre-Check"
        echo "========================"
        echo "User: $(whoami)"
        echo "Working Dir: $(pwd)"
        echo "Python: $(python3 --version)"
        echo "Git Commit: $(git rev-parse --short HEAD)"
        echo ""
        
        echo "ðŸ” Secrets Check:"
        echo "GANCIO_EMAIL: ${GANCIO_EMAIL:+âœ… SET}" 
        echo "GANCIO_EMAIL: ${GANCIO_EMAIL:-âŒ NOT SET}" | grep -q "NOT SET" && echo "âŒ GANCIO_EMAIL missing"
        echo "GANCIO_PASSWORD: ${GANCIO_PASSWORD:+âœ… SET}"
        echo "GANCIO_PASSWORD: ${GANCIO_PASSWORD:-âŒ NOT SET}" | grep -q "NOT SET" && echo "âŒ GANCIO_PASSWORD missing"
        echo "DISCORD_WEBHOOK_URL: ${DISCORD_WEBHOOK_URL:+âœ… SET}"
        echo ""
        
        echo "ðŸŒ Service Check:"
        systemctl is-active gancio && echo "âœ… Gancio service active" || echo "âŒ Gancio service inactive"
        curl -s --connect-timeout 5 http://localhost:13120 >/dev/null && echo "âœ… Gancio web accessible" || echo "âŒ Gancio not accessible"
        echo ""
      env:
        GANCIO_EMAIL: ${{ secrets.GANCIO_EMAIL }}
        GANCIO_PASSWORD: ${{ secrets.GANCIO_PASSWORD }}
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

    - name: ðŸ Python Environment Setup Check
      run: |
        cd scripts/event-sync
        
        echo "ðŸ Python Environment Check"
        echo "==========================="
        
        if [ -d "venv" ]; then
          echo "âœ… Virtual environment found"
          echo "Activating venv..."
          source venv/bin/activate
          
          # Test critical imports
          python3 -c "
import requests
import sys
from bs4 import BeautifulSoup
print('âœ… Basic imports successful')

try:
    from enhanced_multi_venue_sync import scrape_willspub_events
    print('âœ… Enhanced sync import successful')
except Exception as e:
    print(f'âŒ Enhanced sync import failed: {e}')
    sys.exit(1)
    
print('ðŸŽ¯ Python environment ready')
"
        else
          echo "âŒ Virtual environment missing - attempting to create..."
          python3 -m venv venv
          source venv/bin/activate
          pip install -r requirements.txt
          echo "âœ… Virtual environment created"
        fi

    - name: ðŸŽ¸ Orlando Events Sync (Main Process)
      env:
        GANCIO_EMAIL: ${{ secrets.GANCIO_EMAIL }}
        GANCIO_PASSWORD: ${{ secrets.GANCIO_PASSWORD }}
        GANCIO_URL: http://localhost:13120
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        cd scripts/event-sync
        
        echo "ðŸŽ¸ Starting Enhanced GitHub Actions event sync..."
        echo "Using the same working script as cron job"
        
        # Activate virtual environment
        source venv/bin/activate
        
        # Add debug output if requested
        if [ "${{ github.event.inputs.debug_mode }}" = "true" ]; then
          echo "ðŸ› DEBUG MODE ENABLED"
          set -x
        fi
        
        # Run the working automated sync with error handling
        if timeout 300s python3 automated_sync_working.py; then
          echo "âœ… Orlando events sync completed successfully"
        else
          exit_code=$?
          echo "âŒ Sync failed with exit code: $exit_code"
          
          # Capture some debugging info
          echo "ðŸ“Š Debug Information:"
          echo "Python processes:"
          ps aux | grep python | grep -v grep || echo "No Python processes"
          echo "Network connections:"
          ss -tuln | grep :13120 || echo "No connection on port 13120"
          echo "Last few lines of any error logs:"
          tail -20 *.log 2>/dev/null || echo "No log files found"
          
          exit $exit_code
        fi
        
    - name: ðŸ“ Archive Results & Summary
      if: always()
      run: |
        cd scripts/event-sync
        
        echo ""
        echo "ðŸ“Š GitHub Actions Sync Results:"
        echo "==============================="
        if [ -f sync_summary.txt ]; then
          cat sync_summary.txt
        else
          echo "âš ï¸  No sync summary found"
        fi
        
        echo ""
        echo "ðŸ–¼ï¸ Flyers Downloaded:"
        if [ -d flyers ]; then
          flyer_count=$(ls flyers/ 2>/dev/null | wc -l)
          echo "$flyer_count flyer files"
          ls -la flyers/ | tail -5 2>/dev/null || echo "No flyers directory"
        else
          echo "No flyers directory found"
        fi
        
        # Archive results with error handling
        echo ""
        echo "ðŸ’¾ Archiving results..."
        mkdir -p ../../backups/orlando-events
        if [ -f willspub_events.json ]; then
          cp willspub_events.json ../../backups/orlando-events/willspub_$(date +%Y%m%d_%H%M).json
          echo "âœ… Events archived"
        fi
        
        if [ -d flyers ] && [ "$(ls -A flyers)" ]; then
          mkdir -p ../../backups/orlando-flyers  
          cp -r flyers ../../backups/orlando-flyers/flyers_$(date +%Y%m%d_%H%M)/
          echo "âœ… Flyers archived"
        fi
        
        echo "ðŸŽ¯ Enhanced GitHub Actions automation pipeline completed!"
