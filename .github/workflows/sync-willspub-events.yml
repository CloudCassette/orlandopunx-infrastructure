name: ðŸŽ¸ Sync Will's Pub Events

on:
  schedule:
    - cron: '0 9,15,21 * * *'  # Run 3 times daily: 9am, 3pm, 9pm EST
  workflow_dispatch: # Allow manual triggering

jobs:
  sync-events:
    runs-on: self-hosted
    name: ðŸ“… Sync Events from Will's Pub
    
    steps:
    - name: ðŸ”„ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸŽ¯ Scrape Will's Pub Events
      run: |
        cd scripts/event-sync
        
        # Activate virtual environment
        source venv/bin/activate
        
        # Run the scraper to get latest events
        echo "ðŸŽ¸ Scraping events from Will's Pub..."
        python3 willspub_manual_import.py << EOF
        20
        EOF
        
        # Check if new events were found
        EVENTS_COUNT=$(jq length willspub_events.json)
        echo "ðŸ“Š Found $EVENTS_COUNT events from Will's Pub"
        
        # Copy results to a timestamped backup
        mkdir -p ../../backups/willspub-events
        cp willspub_events.* ../../backups/willspub-events/willspub_events_$(date +%Y%m%d_%H%M).
        
        echo "âœ… Event scraping completed"
        echo "ðŸ“ Results saved to: scripts/event-sync/willspub_events.*"
        echo "ðŸ”„ Manual import files ready for Gancio admin review"
        
    - name: ðŸ“‹ Summary Report
      run: |
        cd scripts/event-sync
        echo "ðŸ“Š Will's Pub Event Sync Summary"
        echo "================================="
        echo "ðŸ“… Sync Time: $(date)"
        echo "ðŸ“ Events Found: $(jq length willspub_events.json) events"
        echo "ðŸ“„ Files Generated:"
        echo "   - willspub_events.txt (manual import)"
        echo "   - willspub_events.json (API data)" 
        echo "   - willspub_events.csv (spreadsheet)"
        echo ""
        echo "ðŸŽ¯ Next Steps:"
        echo "   1. Review willspub_events.txt for new events"
        echo "   2. Add interesting events to Gancio admin panel"
        echo "   3. Check orlandopunx.com for updated event listings"

  notify:
    runs-on: ubuntu-latest
    needs: sync-events
    if: always()
    name: ðŸ“¢ Notify Sync Status
    
    steps:
    - name: ðŸ“§ Send Discord Notification
      if: always()
      uses: tsickert/discord-webhook@v6.0.0
      with:
        webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
        content: |
          ðŸŽ¸ **Will's Pub Event Sync**
          
          **Status:** ${{ needs.sync-events.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}
          **Time:** $(date)
          **Repository:** ${{ github.repository }}
          
          ${{ needs.sync-events.result == 'success' && 'ðŸ“… New events scraped and ready for review!' || 'âš ï¸ Event sync failed - check action logs' }}
          
          **Action Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
